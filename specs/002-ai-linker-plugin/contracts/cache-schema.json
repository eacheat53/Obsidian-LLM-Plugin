{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Obsidian AI Linker Cache Schema",
  "description": "JSON schema for the master index cache file and sharded embedding files",
  "version": "1.0.0",
  "definitions": {
    "UUID": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$",
      "description": "UUID v4 format"
    },
    "SHA256Hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash in lowercase hex format"
    },
    "UnixTimestamp": {
      "type": "integer",
      "minimum": 0,
      "description": "Unix timestamp in milliseconds"
    },
    "NoteMetadata": {
      "type": "object",
      "required": ["note_id", "file_path", "content_hash", "last_processed", "tags", "has_frontmatter", "has_hash_boundary", "has_links_section"],
      "properties": {
        "note_id": {
          "$ref": "#/definitions/UUID",
          "description": "Unique identifier for this note"
        },
        "file_path": {
          "type": "string",
          "pattern": "^[^/].*\\.md$",
          "description": "Relative path from vault root, must end in .md"
        },
        "content_hash": {
          "$ref": "#/definitions/SHA256Hash",
          "description": "SHA-256 hash of main content (before HASH_BOUNDARY marker)"
        },
        "last_processed": {
          "$ref": "#/definitions/UnixTimestamp",
          "description": "When this note was last processed"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1,
            "pattern": "^[^\\s]+$"
          },
          "uniqueItems": true,
          "description": "AI-generated tags merged with user tags"
        },
        "has_frontmatter": {
          "type": "boolean",
          "description": "Whether note has valid YAML front-matter"
        },
        "has_hash_boundary": {
          "type": "boolean",
          "description": "Whether note contains <!-- HASH_BOUNDARY --> marker"
        },
        "has_links_section": {
          "type": "boolean",
          "description": "Whether note has <!-- LINKS_START/END --> block"
        }
      },
      "additionalProperties": false
    },
    "NotePairScore": {
      "type": "object",
      "required": ["note_id_1", "note_id_2", "similarity_score", "ai_score", "last_scored"],
      "properties": {
        "note_id_1": {
          "$ref": "#/definitions/UUID",
          "description": "First note UUID (lexicographically smaller)"
        },
        "note_id_2": {
          "$ref": "#/definitions/UUID",
          "description": "Second note UUID (lexicographically larger)"
        },
        "similarity_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Cosine similarity score (0.0 to 1.0)"
        },
        "ai_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "description": "LLM relevance score (0 to 10)"
        },
        "last_scored": {
          "$ref": "#/definitions/UnixTimestamp",
          "description": "When AI scoring was performed"
        }
      },
      "additionalProperties": false
    },
    "CacheStatistics": {
      "type": "object",
      "required": ["total_notes", "total_embeddings", "total_scores", "orphaned_notes"],
      "properties": {
        "total_notes": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of notes in cache"
        },
        "total_embeddings": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of embedding files"
        },
        "total_scores": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of note pair scores"
        },
        "orphaned_notes": {
          "type": "integer",
          "minimum": 0,
          "description": "Notes no longer in vault but still in cache"
        }
      },
      "additionalProperties": false
    },
    "MasterIndex": {
      "type": "object",
      "required": ["version", "last_updated", "notes", "scores", "stats"],
      "properties": {
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Schema version (semantic versioning)"
        },
        "last_updated": {
          "$ref": "#/definitions/UnixTimestamp",
          "description": "When the cache was last modified"
        },
        "notes": {
          "type": "object",
          "patternProperties": {
            "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$": {
              "$ref": "#/definitions/NoteMetadata"
            }
          },
          "additionalProperties": false,
          "description": "Map of note_id to NoteMetadata"
        },
        "scores": {
          "type": "object",
          "patternProperties": {
            "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}:[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$": {
              "$ref": "#/definitions/NotePairScore"
            }
          },
          "additionalProperties": false,
          "description": "Map of 'noteId1:noteId2' composite key to NotePairScore"
        },
        "stats": {
          "$ref": "#/definitions/CacheStatistics",
          "description": "Aggregate statistics"
        }
      },
      "additionalProperties": false
    },
    "EmbeddingVector": {
      "type": "object",
      "required": ["note_id", "embedding", "model_name", "created_at", "content_preview"],
      "properties": {
        "note_id": {
          "$ref": "#/definitions/UUID",
          "description": "Note identifier matching MasterIndex"
        },
        "embedding": {
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 1,
          "description": "Vector embedding (typically 768 or 1024 floats)"
        },
        "model_name": {
          "type": "string",
          "minLength": 1,
          "description": "Jina model used (e.g., 'jina-embeddings-v2-base-en')"
        },
        "created_at": {
          "$ref": "#/definitions/UnixTimestamp",
          "description": "When the embedding was generated"
        },
        "content_preview": {
          "type": "string",
          "maxLength": 200,
          "description": "First 200 chars of content for debugging"
        }
      },
      "additionalProperties": false
    }
  },
  "oneOf": [
    {
      "title": "Master Index File (index.json)",
      "$ref": "#/definitions/MasterIndex"
    },
    {
      "title": "Embedding File (embeddings/<note_id>.json)",
      "$ref": "#/definitions/EmbeddingVector"
    }
  ]
}
